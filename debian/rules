#!/usr/bin/make -f

# Remember to comment this before tagging for a release.
DEB_AUTO_UPDATE_DEBIAN_CONTROL := yes

include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/rules/simple-patchsys.mk
include /usr/share/cdbs/1/class/autotools.mk

CFLAGS = -g -Wall
CXXFLAGS = -g -Wall
ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
DEB_OPT_FLAG = -O0
else
DEB_OPT_FLAG = -O3 -ffast-math
endif
CFLAGS += $(DEB_OPT_FLAG)
CXXFLAGS += $(DEB_OPT_FLAG)

ifeq ($(DEB_BUILD_GNU_TYPE), i486-linux-gnu)
DEB_BUILD_GNU_TYPE = i686-linux-gnu
endif

ifneq (,$(BOINC_BUILD_TYPE))
DEB_BUILD_GNU_TYPE = $(BOINC_BUILD_TYPE)
endif

DEB_CONFIGURE_EXTRA_FLAGS := --enable-client --enable-server

DEB_INSTALL_MANPAGES_boinc-client = boinc_client.1 boinc_cmd.1
DEB_INSTALL_MANPAGES_boinc-manager = boincmgr.1

pre-build::
	aclocal-1.9 -I m4 && autoheader && automake-1.9 && autoconf
	
	docbook2x-man debian/manpages/boinc_client.xml
	docbook2x-man debian/manpages/boinc_cmd.xml
	docbook2x-man debian/manpages/boincmgr.xml

clean::
	dh_clean boinc_client.1
	dh_clean boinc_cmd.1
	dh_clean boincmgr.1

binary-install/boinc-manager::
	install -D debian/tmp/usr/bin/boinc_gui \
	  debian/$(cdbs_curpkg)/usr/bin/boincmgr
	
	for i in `ls locale/client`; do \
	  if [ -f "locale/client/$$i/BOINC Manager.mo" ]; then \
	    install -D -m644 "locale/client/$$i/BOINC Manager.mo" \
	      "debian/$(cdbs_curpkg)/usr/share/locale/$$i/LC_MESSAGES/BOINC Manager.mo"; \
	  fi; \
	done;
	
	dh_desktop -p$(cdbs_curpkg)

binary-install/boinc-server::
	dh_python -p$(cdbs_curpkg)

binary-install/boinc-dev::
	cd debian/$(cdbs_curpkg)/usr/share/boinc/api && \
	  ln -s ../../../include/boinc/api/* . && \
	  ln -s ../../../lib/boinc/api/* .
	
	cd debian/$(cdbs_curpkg)/usr/share/boinc/lib && \
	  ln -s ../../../include/boinc/lib/* . && \
	  ln -s ../../../lib/boinc/lib/* .
