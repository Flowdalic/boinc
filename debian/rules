#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# Uncomment this to compile with gcc-snapshot.
#export  CC=/usr/lib/gcc-snapshot/bin/gcc
#export CXX=/usr/lib/gcc-snapshot/bin/g++
#export CPP=/usr/lib/gcc-snapshot/bin/cpp

include /usr/share/quilt/quilt.make

DEB_HOST_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

ifeq ($(DEB_BUILD_GNU_TYPE), $(DEB_HOST_GNU_TYPE))
  TYPE_FLAGS = --build $(DEB_HOST_GNU_TYPE)
else
  TYPE_FLAGS = --build $(DEB_BUILD_GNU_TYPE) --host $(DEB_HOST_GNU_TYPE)
endif

# On some architectures it is required to change the BOINC platform of the
# core client (with the --with-boinc-platform configure option) to match the
# official BOINC platform, otherwise it would not download any applications,
# because projects mostly provide applications for official BOINC platforms
# only. See http://boinc.berkeley.edu/trac/wiki/BoincPlatforms for the list
# of official BOINC platforms.

# Change BOINC platform alpha-unknown-linux-gnu to alpha-hp-linux-gnu and
# declare alpha-unknown-linux-gnu as alternate platform, because some projects
# offer applications for it.
ifeq ($(DEB_HOST_GNU_TYPE), alpha-linux-gnu)
  TYPE_FLAGS += --with-boinc-platform=alpha-hp-linux-gnu \
    --with-boinc-alt-platform=alpha-unknown-linux-gnu
endif

# Change BOINC platform i486-pc-linux-gnu to i686-pc-linux-gnu.
ifeq ($(DEB_HOST_GNU_TYPE), i486-linux-gnu)
  TYPE_FLAGS += --with-boinc-platform=i686-pc-linux-gnu
endif

# Change BOINC platform i486-pc-kfreebsd-gnu to i686-pc-kfreebsd-gnu to be
# consistent with the official BOINC platform i686-pc-linux-gnu.
ifeq ($(DEB_HOST_GNU_TYPE), i486-kfreebsd-gnu)
  TYPE_FLAGS += --with-boinc-platform=i686-pc-kfreebsd-gnu
endif

# Change BOINC platform ia64-unknown-linux-gnu to ia64-linux-gnu.
ifeq ($(DEB_HOST_GNU_TYPE), ia64-linux-gnu)
  TYPE_FLAGS += --with-boinc-platform=ia64-linux-gnu
endif

# Change BOINC platform powerpc-unknown-linux-gnu to powerpc-linux-gnu.
ifeq ($(DEB_HOST_GNU_TYPE), powerpc-linux-gnu)
  TYPE_FLAGS += --with-boinc-platform=powerpc-linux-gnu
endif

# Change BOINC platform powerpc64-unknown-linux-gnu to ppc64-linux-gnu and
# declare powerpc-linux-gnu as alternate platform.
ifeq ($(DEB_HOST_GNU_TYPE), powerpc64-linux-gnu)
  TYPE_FLAGS += --with-boinc-platform=ppc64-linux-gnu \
    --with-boinc-alt-platform=powerpc-linux-gnu
endif

# Change BOINC platform sparc-unknown-linux-gnu to sparc-sun-linux-gnu.
ifeq ($(DEB_HOST_GNU_TYPE), sparc-linux-gnu)
  TYPE_FLAGS += --with-boinc-platform=sparc-sun-linux-gnu
endif

# Declare i686-pc-kfreebsd-gnu as alternate platform for
# x86_64-pc-kfreebsd-gnu.
ifeq ($(DEB_HOST_GNU_TYPE), x86_64-kfreebsd-gnu)
  TYPE_FLAGS += --with-boinc-alt-platform=i686-pc-kfreebsd-gnu
endif

CFLAGS += -g -Wall
CXXFLAGS += -g -Wall
LDFLAGS += -Wl,--as-needed

CFLAGS_boinc-client := $(CFLAGS)
CXXFLAGS_boinc-client := $(CXXFLAGS)

ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
  DEB_OPT_FLAGS = -O0
  DEB_OPT_FLAGS_boinc-client = -O0
else
  DEB_OPT_FLAGS = -O2
  DEB_OPT_FLAGS_boinc-client = -O3
endif

CFLAGS += $(DEB_OPT_FLAGS)
CXXFLAGS += $(DEB_OPT_FLAGS)

CFLAGS_boinc-client += $(DEB_OPT_FLAGS_boinc-client)
CXXFLAGS_boinc-client += $(DEB_OPT_FLAGS_boinc-client)

CFGFLAGS = \
  $(TYPE_FLAGS) \
  --prefix=/usr \
  --enable-client \
  --enable-server \
  --enable-unicode \
  --with-ssl \
  CFLAGS="$(CFLAGS)" \
  CXXFLAGS="$(CXXFLAGS)" \
  LDFLAGS="$(LDFLAGS)"

CFGFLAGS_boinc-client = \
  $(TYPE_FLAGS) \
  --enable-client \
  --disable-server \
  --with-ssl \
  --without-wx-config \
  CFLAGS="$(CFLAGS_boinc-client)" \
  CXXFLAGS="$(CXXFLAGS_boinc-client)" \
  LDFLAGS="$(LDFLAGS)"

unit-test:
	xmllint --nonet --noout \
	  debian/conffiles/cc_config.xml \
	  debian/conffiles/global_prefs_override.xml

pre-build: unit-test patch pre-build-stamp
pre-build-stamp:
	cp -f /usr/share/misc/config.guess config.guess
	cp -f /usr/share/misc/config.sub config.sub
	aclocal-1.9 -I m4 && autoheader && automake-1.9 && autoconf
	
	docbook2x-man debian/manpages/update-boinc-applinks.xml
	touch $@

build: pre-build build-stamp
build-stamp: build-stamp-boinc-client
	dh_testdir
	./configure $(CFGFLAGS)
	$(MAKE)
	touch $@

build-stamp-boinc-client:
	dh_testdir
	./configure $(CFGFLAGS_boinc-client)
	$(MAKE)
	cp client/boinc.unmodified client/boinc_client.optimized
	touch $@

clean: clean-patched unpatch
clean-patched:
	dh_testdir
	dh_testroot
	rm -f pre-build-stamp
	rm -f build-stamp
	rm -f build-stamp-boinc-client
	
	dh_clean client/boinc_client.optimized
	
	[ ! -f Makefile ] || $(MAKE) distclean
	
	dh_clean update-boinc-applinks.1
	
	dh_clean \
	  api/Makefile.in \
	  apps/Makefile.in \
	  client/Makefile.in \
	  clientgui/Makefile.in \
	  db/Makefile.in \
	  doc/Makefile.in \
	  doc/manpages/Makefile.in \
	  lib/Makefile.in \
	  m4/Makefile.in \
	  py/Makefile.in \
	  py/Boinc/Makefile.in \
	  sched/Makefile.in \
	  sea/Makefile.in \
	  test/Makefile.in \
	  tools/Makefile.in \
	  zip/Makefile.in \
	  zip/unzip/Makefile.in \
	  zip/zip/Makefile.in \
	  Makefile.in \
	  aclocal.m4 \
	  config.h.in \
	  configure
	
	debconf-updatepo

BOINC_SERVER_DIR=debian/boinc-server/usr/share/boinc-server

install: install-arch
install-arch: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs
	
	$(MAKE) install DESTDIR=$(CURDIR)/debian/tmp
	
	dh_install -a
	
	# Install files for the boinc-client package.
	install -D client/boinc_client.optimized \
	  debian/boinc-client/usr/bin/boinc_client
	
	install -D lib/boinccmd.unmodified \
	  debian/boinc-client/usr/bin/boinc_cmd
	
	# Install files for the boinc-manager package.
	install -D clientgui/boincmgr.unmodified \
	  debian/boinc-manager/usr/bin/boincmgr
	
	for i in `ls locale/client`; do \
	  if [ -f "locale/client/$$i/BOINC Manager.mo" ]; then \
	    install -D -m644 "locale/client/$$i/BOINC Manager.mo" \
	      "debian/boinc-manager/usr/share/locale/$$i/LC_MESSAGES/BOINC Manager.mo"; \
	  fi; \
	done;
	# The en_US po file is actually a po template, thus the corresponding
	# "BOINC Manager.mo" is empty and useless.
	rm -rf debian/boinc-manager/usr/share/locale/en_US/
	
	# Install files for the boinc-server package.
	for i in debian/boinc-server/usr/lib/boinc-server/sched/*; do \
	  dh_link -pboinc-server \
	    usr/lib/boinc-server/sched/`basename $$i` \
	    usr/share/boinc-server/sched/`basename $$i`; \
	done;
	
	# Remove Python shebang from Boinc module files that are not scripts.
	sed -i -e '1 d' \
	  $(BOINC_SERVER_DIR)/py/Boinc/add_util.py \
	  $(BOINC_SERVER_DIR)/py/Boinc/boincxml.py \
	  $(BOINC_SERVER_DIR)/py/Boinc/configxml.py \
	  $(BOINC_SERVER_DIR)/py/Boinc/projectxml.py
	
	sed -i -e 's/boinc_path_config/Boinc.boinc_path_config/' \
	  $(BOINC_SERVER_DIR)/py/Boinc/database.py \
	  $(BOINC_SERVER_DIR)/py/Boinc/setup_project.py \
	  $(BOINC_SERVER_DIR)/tools/make_project \
	  $(BOINC_SERVER_DIR)/tools/upgrade

binary-arch: build install-arch
	dh_testdir -a
	dh_testroot
	dh_installchangelogs -a -k checkin_notes
	dh_installdocs -a
	dh_installdebconf -a
	dh_installexamples -a
	dh_installmenu -a
	dh_desktop -a
	dh_installinit -a
	dh_installman -a
	dh_installudev -a
	dh_buildinfo -a
	dh_link -a
	dh_strip -a --dbg-package=boinc-dbg
	dh_compress -a
	dh_fixperms -a
	chmod 755 \
	  debian/boinc-client/usr/share/boinc-client/udev-cpu_share \
	  debian/boinc-client/usr/share/bug/boinc-client/script \
	  debian/boinc-manager/usr/share/doc/boinc-manager/examples/run-boincmgr
	dh_pysupport -a 
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-arch

origDir ?= .

get-orig-source:
	LATEST_VERSION=`svn list http://boinc.berkeley.edu/svn/tags/ | \
	  sed 's/boinc_core_release_\(.*\)\//\1/' | \
	  sort -g -t_ -k1 -k2 -k3 | sed 's/_/./g' | tail -n 1 | tr -d '\n'`; \
	EXB=/tmp/export-boinc; \
	svn export svn://svn.debian.org/pkg-boinc/scripts/export-boinc $$EXB; \
	$$EXB -r $$LATEST_VERSION -t $(origDir); \
	rm -f $$EXB

.PHONY: unit-test pre-build build clean clean-patched install install-arch \
  binary-arch binary get-orig-source
